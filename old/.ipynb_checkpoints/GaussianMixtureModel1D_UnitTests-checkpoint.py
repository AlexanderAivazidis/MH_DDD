# Index SlideName  Section  Cycle1-Batch  Cycle2-Batch  z-coordinate Astrocyte Oligodendrocyte GABAergicNeuron   OPC Neuron Unclassified
# 0       MH_DDD_006R        1             1             1            12      7965            9289             763  3147     93        42479
# 1       MH_DDD_006R        2             1             1            16      5783            2081             328  1323   3076        23390
# 2       MH_DDD_006R        3             1             1            22      5335            1987            1090  1550   2808        22339
# 3       MH_DDD_006S        1             1             1            11      4049            5169            2057  1520     11        17030
# 4       MH_DDD_006S        2             1             1            12      2542            2760             451   654   4566        11163
# 5       MH_DDD_006S        3             1             1            22      2440            4788              62   802    154        11990
# 6       MH_DDD_006S        4             1             1            23      2758            3655             238   899    263        16891
# 7   190830_030030-V        1             1             2            28     11799           12625             786  3330     21        52837
# 8   190830_030030-V        2             1             2            31      9436            9290            1416  2485   9020        57131
# 9       MH_DDD_0076        1             1             2            77       737            1673             115   388     53         5206
# 10      MH_DDD_0076        2             1             2            82      1358            8742             218  2110     39        14652
# 11      MH_DDD_0076        3             1             2            91      2024           14722            1897  3661    193        30725
# 12  190829_193316-V        1             1             2            77       289            2554              46  1885   3763         8147
# 13  190829_193316-V        2             1             2            82      2440            8511             282  1260   2256        20241
# 14  190829_193316-V        3             1             2            91       NaN             NaN             NaN   NaN    NaN          NaN
# 15  190829_213532-V        1             2             2            24      4026            7012            1858  1790   1939        18423
# 16  190829_213532-V        2             2             2            31      4879           10119            2117  2410      0        21545
# 17  190829_213532-V        3             2             2            39      7578            8408            2430  2389      0        31361
# 18  190829_185042-V        1             1             2             9      2181             624            3052   618    423         8903
# 19      MH_DDD_007A        1             1             2            24      6961            9877            2995  3454   9988        26705
# 20      MH_DDD_007A        2             1             2            31      7661            7384            3000  2976  13774        30361
# 21      MH_DDD_007A        3             1             2            36      7310            7161            3666  2919   2314        32167
# 22  190816_040549-V        1             1             2            36      7586           10543            1085  1576     31        25114
# 23  190816_040549-V        2             1             2            43      8701           14553            1802  3067     11        32421
# 24  190816_040549-V        3             1             2            47     10913           16743            3883  4642    179        46833
# 25  190830_044231-V        1             1             2             7      4522            2191            2303  1412     42        15771
# 26  190904_035430-V        1             1             3            43     15921            6783            5546  6629  21289        57978
# 27  190904_035430-V        2             1             3            47     14654            1119            6626  6451  24044        62123
# 28  190903_011924-V        1             1             3            52      8820           12685            2145  4616  13712        54691
# 29  190903_011924-V        2             1             3            57     11022           17398            1536  5164   8652        68579
# 30  190903_011924-V        3             1             3            64     13536           12376            1739  5003  34905        49991
# 31  190820_050438-V        1             1             3            52      6736           10615             316  2351    160        26685
# 32  190820_050438-V        2             1             3            57      8371            5005             774  3845     29        45582
# 33  190820_050438-V        3             1             3            64     10874           15464            1851  5263   1558        49423
# 34  190902_233224-V        1             2             3             9     10170           11963           12229  2227      8        37432
# 35  190902_233224-V        2             2             3            12      7308            2110            2470   958   6353        18565
# 36  190902_233224-V        3             2             3            22      5604            1942            4902  1578   7476        18814
# 37  190904_055656-V        1             2             3            24     13318            4560            3428  4489  23860        48898
# 38  190904_055656-V        2             2             3            31     14652            9865            3874  3851  16760        49821
# 39  190904_055656-V        3             2             3            36     13292            3681            9118  3427  17898        45400
# 40  190819_215457-V        1             2             3            46      8484            1025            3633  2657   7034        25188
# 41  190819_215457-V        2             2             3            52     13102             460            6638  4629     18        42640
# 42  190819_215457-V        3             2             3            57     11410               0            5181  6314  21339        48304
# 43  190820_075030-V        1             2             3            64     12334             521            9951  5754   9112        48316
# 44  190820_090258-V        1             2             3            77       728              51               0   334    335         3661
# 45  190820_090258-V        2             2             3            82      1505            1092            4196  3145  10057        24199
# 46  190820_090258-V        3             2             3            91       NaN             NaN             NaN   NaN    NaN          NaN
# 47  190820_025329-V        1             2             3            77      1015            2548             666   606     14         6601
# 48  190820_025329-V        2             2             3            81      1773            8767            3942  2343     36        23003
# 49  190820_025329-V        3             2             3            91      1294           10407            5745  2601   7484        25205
# 50  190903_090400-V        1             2             3            12     11941             399            1459  2559  25815        32689
# 51  190903_090400-V        2             2             3            20      7529              44            1728  1749  16664        19047
# 52  190902_204823-V        1             2             3            23     15902             997            7607  6294  13112        60746
# 53  190902_204823-V        2             2             3            31     15897             936            6156  4347  24427        55498
# 54  190902_204823-V        3             2             3            36     12388            1050            9599  2720  17116        42463
# 55  190904_003222-V        1             2             3            43     16061            2957            4327  6540   9689        55432
# 56  190904_003222-V        2             2             3            47     21663            3054            5972  7404    333        83026
# 57  190904_003222-V        3             2             3            52     19582            2483            8245  6069   1895        74818
# 58  190830_082358-V        1             2             3            57      9383            3796            3097  4649   1319        35527
# 59  190830_082358-V        2             2             3            64     15793             103            7538  6467     14        52367
# 60  190903_202721-V        1             2             3             9     10748           13638            5039  2749    125        38099
# 61  190903_202721-V        2             2             3            12      8854            4336            3353  2273   2925        29980
# 62  190903_202721-V        3             2             3            20      5640            1416            3047  1183   9434        15313
# 63  190903_220629-V        1             2             3            24     13115           17264            3928  4529   2589        56071
# 64  190903_220629-V        2             2             3            31     13015           14133            3950  3629    233        59894
# 65  190903_220629-V        3             2             3            36     12842           12085            4241  4728      7        60746
# 66  190830_052736-V        1             2             3            45      5516            3373            1771  2227   6375        17542
# 67  190830_052736-V        2             2             3            48     10190            3216            2629  2710   3085        29285
# 68  190830_052736-V        3             2             3            54     11949             281            2051  4796  21805        34314
# 69  190902_174907-V        1             2             3            57     11916           12569            3785  2937  21855        41107
# 70  190902_174907-V        2             2             3            58     16944           19809            8329  4291   1024        64050
# 71  190902_174907-V        3             2             3            64     18139            2789            7731  4504  31482        62329
# 72  190820_005302-V        1             2             3            77      1002            1232             132   329     50         5242
# 73  190820_005302-V        2             2             3            82      1001            3710             523  1381    925        11201
# 74  190820_005302-V        3             2             3            91      1149             435            3355  1924    148        20545
# 75  190820_111050-V        1             2             3             9      7279            4530            2871  2293      0        27464
# 76  190820_111050-V        2             2             3            12      5155            3737            2187   750      0        16651
# 77  190820_111050-V        3             2             3            20      5689            2940            4005  2112      1        21740
# 78  190903_172617-V        1             2             3            43     10396           13770            3858  4310  17007        37956
# 79  190903_172617-V        2             2             3            47     14569           20070            9181  6516    320        65545
# 80  190903_172617-V        3             2             3            52     14684           17695           10448  6292     46        63421
# 81  190903_070152-V        1             2             3            57     12632           16245            3659  6804    518        71733
# 82  190903_070152-V        2             2             3            64     14959           20662            6523  7527   6738        71432
# 83  190903_041218-V        1             2             3            78      1343            5864            3095  1625    598        18555
# 84  190903_041218-V        2             2             3            80       483           10347            2239  2742   6803        22301
# 85  190903_041218-V        3             2             3            82       990           14887            3907  3027  10274        30531
# 86  190903_041218-V        4             2             3            91      2899           10260            9048  4038  12201        40191

# Import modules and packages:
import numpy as np, pandas as pd, matplotlib.pyplot as plt, seaborn as sns
%matplotlib inline
sns.set_context('paper')
sns.set_style('darkgrid')
import os
os.chdir('/home/jovyan/MH_DDD/')
import matplotlib.pyplot as plt; plt.style.use('ggplot')
from matplotlib import figure
import pymc3 as pm, theano.tensor as tt
from pymc3.math import logsumexp
#%env THEANO_FLAGS=device=cpu,floatX=float32
import theano
from pymc3 import Normal, Metropolis, sample, MvNormal, Dirichlet, \
    DensityDist, find_MAP, NUTS, Slice
from theano.tensor.nlinalg import det
import seaborn as sns
from pymc3Utils import sample_prior, exp_normalize
from pymc3Distributions import logp_normal
import pandas as pd
from fnmatch import fnmatch
import pickle
import sys

# Get all evaluation files:
root = '../data/KptnMouse/RNAscope'
pattern = "Objects_Population - Nuclei.txt"
allFiles = []
slideNames = []
for path, subdirs, files in os.walk(root):
    for name in files:
        if fnmatch(name, pattern):
            allFiles.append(os.path.join(path, name))
            slideNames.append(str.split(allFiles[-1], '/')[4])

successfullSections = ('MH_DDD_006R-2', 'MH_DDD_006S-1', 'MH_DDD_006S-4')
unsuccessfullSections = ('MH_DDD_006R-1', 'MH_DDD_006R-3', 'MH_DDD_006S-2', 'MH_DDD_006S-3')
            
files = (allFiles[10], allFiles[10], allFiles[10], allFiles[10], allFiles[15], allFiles[15], allFiles[15], allFiles[15]) 
sections = (1,2,3,1,2,3,4)

for i in range(len(files)):
    
    print(i)
    # Import data:
    kptn_data_all = pd.read_csv(files[i], sep = '\t' , skiprows = 8, header = 1)
    kptn_data = np.asarray(kptn_data_all[['Position X [µm]', 'Position Y [µm]', 'Nuclei - Intensity Nucleus Alexa 568 Mean', 'Nuclei - Intensity Nucleus Atto 490LS Mean', 'Nuclei - Intensity Nucleus Alexa 488 Mean', 'Nuclei - Intensity Nucleus Alexa 647 Mean', 'Nuclei - Intensity Nucleus Atto 425 Mean']])
    channelOrder = ('568', '490LS', '488', '647', '425')
    celltypeOrder = ('Astrocyte', 'Oligodendrocyte', 'GABAergicNeuron', 'OPC', 'Neuron')

    # Filter out 1% smallest and 5% of largest nuclei as segmentation errors:

    volumes = np.asarray(kptn_data_all['Nuclei - Nucleus Volume [µm³]'])
    volumes = volumes[volumes.argsort()]
    minVol = volumes[int(np.round(len(volumes)*0.01))]
    maxVol = volumes[int(np.round(len(volumes)*0.95))]

    kptn_data = kptn_data[(kptn_data_all['Nuclei - Nucleus Volume [µm³]'] > minVol) & (kptn_data_all['Nuclei - Nucleus Volume [µm³]'] < maxVol),:]
    volumes = volumes[(volumes > minVol) & (volumes < maxVol)]
    kptn_data = kptn_data[kptn_data[:,1].argsort(),:]
    kptn_data_log = np.log2(kptn_data[:,2:])
    
    # Make some plots to get overview of data:

    sectionNumber = np.zeros(np.shape(kptn_data_log)[0])
    count = 1
    sectionNumber[0] = count
    for j in range(1, np.shape(kptn_data_log)[0]):
        if abs(kptn_data[j,1] - kptn_data[j-1,1]) > 1000:
            if sum(sectionNumber == count) > 5000:
                count = count + 1
            else:
                sectionNumber[sectionNumber == count] = np.nan
        sectionNumber[j] = count

    uniqueSectionNumbersWithNaN = np.unique(sectionNumber)    
    uniqueSectionNumbers = uniqueSectionNumbersWithNaN[~np.isnan(uniqueSectionNumbersWithNaN)]        
    
    # Run GaussianMixture model for each section and channel separatly:

    data = kptn_data_log
    n_samples = np.shape(data)[0]
    dimensions = np.shape(data)[1]
    alpha = np.array(((2,1,1),(10,1,1), (10,1,1), (10,1,1), (1,1,1)))
    
    channel = 4
    section = sections[i]
    
    with pm.Model() as model:
        w = pm.Dirichlet('w', alpha[channel])
        mus = pm.Normal('mu', mu = np.array((np.mean(np.sort(data[sectionNumber == section,channel])[:1000])+0.5, np.mean(np.sort(data[sectionNumber == section,channel])[:1000]) + 2, np.mean(np.sort(data[sectionNumber == section,channel])[:1000]) + 2)), sigma = np.array((0.1,1,1)), shape = 3)
        sigmas = pm.Gamma('sigma', mu = np.array((0.1,1,1)), sigma = np.array((0.1,1,1)), shape = 3)
        prior = sample_prior(samples = 1000)
        x = pm.NormalMixture('x_obs', w, mus, sigma = sigmas, observed=data[sectionNumber == section,channel])

        # Plot prior for some parameters:
        plt.hist(prior['mu'])
        plt.show()

        plt.hist(prior['sigma'])
        plt.show() 

        plt.hist(prior['w'])
        plt.show()

        # Fit:
        with model:
            advi_fit = pm.fit(n=2000, obj_optimizer=pm.adagrad(learning_rate=1e-1), method = 'advi')  

        # Show results advi:
        advi_elbo = pd.DataFrame(
            {'log-ELBO': -np.log(advi_fit.hist),
             'n': np.arange(advi_fit.hist.shape[0])})
        _ = sns.lineplot(y='log-ELBO', x='n', data=advi_elbo)
        advi_trace = advi_fit.sample(10000)
        pm.summary(advi_trace, include_transformed=False)

        # Calculate class membership, by using advi_trace and logp_normal function:                            
        confidenceThreshold = 0.95
        class0LogProb = [logp_normal(np.mean(advi_trace.get_values('mu')[:,0]), np.mean(advi_trace.get_values('sigma')[:,0]) , data[k,channel]) for k in np.where(sectionNumber == section)]
        class1LogProb = [logp_normal(np.mean(advi_trace.get_values('mu')[:,1]), np.mean(advi_trace.get_values('sigma')[:,1]) , data[k,channel]) for k in np.where(sectionNumber == section)]
        normalizedProbs = [exp_normalize(np.array((class0LogProb[0][i], class1LogProb[0][i]))) for i in range(len(class0LogProb[0]))]
        maxProbs = [max(normalizedProbs[i]) for i in range(len(normalizedProbs))]
        classMembership = [np.argmax(normalizedProbs[i]) for i in range(len(normalizedProbs))]
        confidentClass = [2 if maxProbs[i] < confidenceThreshold else classMembership[i] for i in range(len(classMembership))]
        # i.e. a value of 2 corresponds to a classification below our confidence threshold, unlike values 0 or 1

        ### Plot results:

        # Histograms:
        if sum(np.array(confidentClass) == 1) > 0:
            boundary1 = min(data[sectionNumber == section,channel][np.array(confidentClass) == 1])
            # i.e. what's the minimum value to confidently classify a cell as positive for this marker?
        else:
            boundary1 = np.inf
        if sum(np.array(confidentClass) == 2) > 0:
            boundary2 = min(data[sectionNumber == section,channel][np.array(confidentClass) == 2])
            # i.e. what's the minimum value to classify a cell into the 'unsure' category
        else:
            boundary2 = 0
        fig = plt.figure()
        fig, ax = plt.subplots()
        N, bins, patches = ax.hist(data[sectionNumber == section,channel], edgecolor='white', linewidth=1, bins = 100)
        for j in range(0, len(patches)):
            if bins[j] < boundary2:
                patches[j].set_facecolor('blue')   
            elif bins[j] < boundary1:
                patches[j].set_facecolor('black')
            else:
                patches[j].set_facecolor('red')

        # Scatterplots:
        colours = np.repeat('black', sum(sectionNumber == section))                            
        if sum(np.array(confidentClass) == 1) > 0:
            colours[np.array(confidentClass) == 1] = 'red'  
                          
        plt.scatter(kptn_data[sectionNumber == section,0], np.exp(data[sectionNumber == section,channel]), c = colours, s = 0.1)
        plt.gca().set_title('Intensity and Classification Channel ' + channelOrder[channel])
        plt.show()
                              
        plt.scatter(kptn_data[sectionNumber == section,0], data[sectionNumber == section,channel], c = colours, s = 0.1)                         
        plt.gca().set_title('Log Intensity and Classification Channel ' + channelOrder[channel])
        plt.show()

        # Slide location of each cell type (including unclassified):
  
        plt.scatter(kptn_data[sectionNumber == section,0][np.array(confidentClass) == 1], kptn_data[sectionNumber == section,1][np.array(confidentClass) == 1], s = 0.05)
        plt.gca().set_title('Nuclei Positive Classification Slide  ' + str(files[i]) + " Section " + str(int(section)) + " Channel " + channelOrder[channel] + ".png")
        plt.show()
